set(SAM_CLI_TOOLS "sam-cli-tools")

file(GLOB SAM_CLI_TOOLS_SRC_FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/clitoolsmain.h
    ${CMAKE_CURRENT_SOURCE_DIR}/clitoolsmain.cpp
)

add_executable(${SAM_CLI_TOOLS} ${SAM_CLI_TOOLS_SRC_FILES})

set_target_properties(${SAM_CLI_TOOLS} PROPERTIES VERSION ${SAM_PROJECT_VERSION})

target_link_libraries(${SAM_CLI_TOOLS} PRIVATE 
    ${SAM_ENGINE} 
)

# When we use any header inside ${SAM_CLI_TOOLS}, it must know where these headers are.
target_include_directories(${SAM_CLI_TOOLS} PRIVATE 
    "${CMAKE_CURRENT_SOURCE_DIR}/" 
)

# Specify the directory containing the shared libraries.
set(PE_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/PE-engine/Debug")
set(BYTE_PIXEL_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/byte-pixel-engine/Debug")
set(PE_PATHLS_GENERATOR_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/PE-pathls-generator/Debug")
set(SAM_MODELS_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/models/Debug")
set(SCAN_AREAS_PROCESSOR_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/scan-areas-processor/Debug")
set(SAM_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/Debug")

# TODO: Why copy_if_different isn't working?
# Copy the shared libraries to the executable directory.
file(GLOB SAM_DLLS 
    "${PE_ENGINE_LIB_DIR}/${PE_ENGINE}.dll"
    "${BYTE_PIXEL_ENGINE_LIB_DIR}/${BYTE_PIXEL_ENGINE}.dll"
    "${PE_PATHLS_GENERATOR_LIB_DIR}/${PE_PATHLS_GENERATOR}.dll"
    "${SAM_MODELS_LIB_DIR}/${SAM_MODELS}.dll"
    "${SAM_ENGINE_LIB_DIR}/${SAM_ENGINE}.dll"
    "${SCAN_AREAS_PROCESSOR_LIB_DIR}/${SCAN_AREAS_PROCESSOR}.dll"
)
foreach(SAM_DLL ${SAM_DLLS})
    add_custom_command(TARGET ${SAM_CLI_TOOLS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy ${SAM_DLL} $<TARGET_FILE_DIR:${SAM_CLI_TOOLS}>
                    COMMENT "Copying ${SAM_DLL} to the executable directory."
    )
endforeach()

# Copy the onnx dlls to the executable directory.
if (MSVC)
    file(GLOB ORT_DLLS 
        "${ONNXRUNTIME_ROOTDIR}/lib/onnxruntime.dll"
        "${ONNXRUNTIME_ROOTDIR}/lib/onnxruntime_providers_shared.dll"
    )
    foreach(ORT_DLL ${ORT_DLLS})
        add_custom_command(TARGET ${SAM_CLI_TOOLS} POST_BUILD
                        COMMAND ${CMAKE_COMMAND} -E copy ${ORT_DLL}  $<TARGET_FILE_DIR:${SAM_CLI_TOOLS}>
                        COMMENT "Copying ${ORT_DLL} to the executable directory."
        )
    endforeach()
endif()

# Copy the lief dlls to the executable directory.
# file(GLOB LIEF_DLLS 
#     "${PROJECT_BINARY_DIR}/.lief-build/Debug/LIEF.dll" 
# )
# foreach(LIEF_DLL ${LIEF_DLLS})
#     add_custom_command(TARGET ${SAM_CLI_TOOLS} POST_BUILD
#                     COMMAND ${CMAKE_COMMAND} -E copy ${LIEF_DLL}  $<TARGET_FILE_DIR:${SAM_CLI_TOOLS}>
#                     COMMENT "Copying ${LIEF_DLL} to the executable directory."
#     )
# endforeach()

# Copy the model to the executable directory.
file(GLOB SAM_MODELS 
    "${STATIC_ANN_ONNX_MODELPATH}"
    "${STATIC_ANN_STANDARDIZE_PARAMS}"
    "${STATIC_CNN_ONNX_MODELPATH}"
    "${STATIC_CNN_COLORMAP}"
)
foreach(SAM_MODEL ${SAM_MODELS})
    add_custom_command(TARGET ${SAM_CLI_TOOLS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy ${SAM_MODEL} $<TARGET_FILE_DIR:${SAM_CLI_TOOLS}>
                    COMMENT "Copying ${SAM_MODEL} to the executable directory."
    )
endforeach()

# TODO: Why is this needed?
add_test(NAME ${SAM_CLI_TOOLS} COMMAND ${SAM_CLI_TOOLS})
