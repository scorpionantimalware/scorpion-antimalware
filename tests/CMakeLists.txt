set(SAM_ENGINE_TESTS "sam-engine-tests")

file(GLOB SAM_ENGINE_TESTS_SRC_FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/testsmain.h
    ${CMAKE_CURRENT_SOURCE_DIR}/testsmain.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/samenginetests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/PE-engine/peenginetests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/models/staticannpeclassifiertests.cpp
)

# TODO: Is this needed?
enable_testing()

# For Windows: Prevent overriding the parent project's compiler/linker settings as mentioned in the official documentation.
if(WIN32)
    set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
endif()

set(GTEST_LIBRARIES 
    "GTest::gtest" 
    "GTest::gtest_main"  
)

# Check https://cmake.org/cmake/help/latest/module/FindGTest.html for more information.
find_package(GTest CONFIG)
if(NOT GTest_FOUND)
    if(EXISTS "${SAM_ROOT}/externals/googletest/googletest/include/gtest/gtest.h")
        set(BUILD_SHARED_LIBS ON CACHE BOOL "" FORCE)
        set(BUILD_GMOCK OFF CACHE BOOL "" FORCE)
        message(STATUS "Found GTest: ${SAM_ROOT}/externals/googletest/googletest/include/gtest/gtest.h")
        add_subdirectory("${SAM_ROOT}/externals/googletest" "${SAM_ROOT}/.build/.googletest-build/")
    else()
        message(FATAL_ERROR "Cannot find GTest package.")
    endif()
endif()

add_executable(${SAM_ENGINE_TESTS} ${SAM_ENGINE_TESTS_SRC_FILES})

set_target_properties(${SAM_ENGINE_TESTS} PROPERTIES VERSION ${SAM_PROJECT_VERSION})

target_link_libraries(${SAM_ENGINE_TESTS} PRIVATE 
    ${GTEST_LIBRARIES} 
    ${SAM_ENGINE} 
)

# When we use any header inside ${SAM_ENGINE_TESTS}, it must know where these headers are.
target_include_directories(${SAM_ENGINE_TESTS} PRIVATE 
    "${CMAKE_CURRENT_SOURCE_DIR}/" 
    "${SAM_ROOT}/externals/googletest/googletest/include/" 
)

# Specify the directory containing the shared libraries.
set(PE_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/PE-engine/Debug")
set(BYTE_PIXEL_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/byte-pixel-engine/Debug")
set(SAM_MODELS_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/models/Debug")
set(SAM_PARSER_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/sam-parser/Debug")
set(SAM_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/Debug")

# TODO: Why copy_if_different isn't working?
# Copy the shared libraries to the executable directory.
file(GLOB SAM_DLLS 
    "${PE_ENGINE_LIB_DIR}/${PE_ENGINE}.dll"
    "${BYTE_PIXEL_ENGINE_LIB_DIR}/${BYTE_PIXEL_ENGINE}.dll"
    "${SAM_MODELS_LIB_DIR}/${SAM_MODELS}.dll"
    "${SAM_PARSER_LIB_DIR}/${SAM_PARSER}.dll"
    "${SAM_ENGINE_LIB_DIR}/${SAM_ENGINE}.dll"
)
foreach(SAM_DLL ${SAM_DLLS})
    add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${SAM_DLL} $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                    COMMENT "Copying ${SAM_DLL} to the executable directory."
    )
endforeach()

# Copy the GTest dlls to the executable directory.
file(GLOB GTEST_DLLS 
    "${PROJECT_BINARY_DIR}/bin/Debug/gtest.dll" 
    "${PROJECT_BINARY_DIR}/bin/Debug/gtest_main.dll" 
)
foreach(GTEST_DLL ${GTEST_DLLS})
    add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${GTEST_DLL}  $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                    COMMENT "Copying ${GTEST_DLL} to the executable directory."
    )
endforeach()

# Copy the onnx dlls to the executable directory.
if (MSVC)
    file(GLOB ORT_DLLS 
        "${ONNXRUNTIME_ROOTDIR}/lib/onnxruntime.dll"
        "${ONNXRUNTIME_ROOTDIR}/lib/onnxruntime_providers_shared.dll"
    )
    foreach(ORT_DLL ${ORT_DLLS})
        add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                        COMMAND ${CMAKE_COMMAND} -E copy_if_different ${ORT_DLL}  $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                        COMMENT "Copying ${ORT_DLL} to the executable directory."
        )
    endforeach()
endif()

# Copy the model to the executable directory.
file(GLOB SAM_MODELS 
    "${STATIC_ANN_ONNX_MODELPATH}"
    # "${STATIC_CNN_ONNX_MODELPATH}"
)
foreach(SAM_MODEL ${SAM_MODELS})
    add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${SAM_MODEL} $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                    COMMENT "Copying ${SAM_MODEL} to the executable directory."
    )
endforeach()

# TODO: Why is this needed?
add_test(NAME ${SAM_ENGINE_TESTS} COMMAND ${SAM_ENGINE_TESTS})
