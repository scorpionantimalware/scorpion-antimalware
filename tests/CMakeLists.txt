# Caching the library name to be used in the parent scope.
set(SAM_ENGINE_TESTS "sam_engine_tests" CACHE STRING "SAM Engine tests library name.")

file(GLOB SAM_ENGINE_TESTS_SRC_FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/testsmain.h
    ${CMAKE_CURRENT_SOURCE_DIR}/testsmain.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/samenginetests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/PE-engine/peenginetests.cpp
)

# TODO: Is this needed?
enable_testing()

# Check https://cmake.org/cmake/help/latest/module/FindGTest.html for more information.
find_package(GTest REQUIRED)

add_executable(${SAM_ENGINE_TESTS} ${SAM_ENGINE_TESTS_SRC_FILES})

set_target_properties(${SAM_ENGINE_TESTS} PROPERTIES VERSION ${SAM_PROJECT_VERSION})

# You can use GTEST_BOTH_LIBRARIES which contains both gtest and gtest_main instead of GTEST_LIBRARIES and GTEST_MAIN_LIBRARIES.
# The GTEST_BOTH_LIBRARIES, GTEST_LIBRARIES, and GTEST_MAIN_LIBRARIES variables comes from the find_package(GTest) call above.
target_link_libraries(${SAM_ENGINE_TESTS} PRIVATE 
    ${GTEST_LIBRARIES}
    ${GTEST_MAIN_LIBRARIES}
    ${SAM_ENGINE} 
)

# When we use any header inside ${SAM_ENGINE_TESTS}, it must know where these headers are.
# The GTEST_INCLUDE_DIRS variable comes from the find_package(GTest) call above.
target_include_directories(${SAM_ENGINE_TESTS} PRIVATE 
    "${CMAKE_CURRENT_SOURCE_DIR}/" 
    "${GTEST_INCLUDE_DIRS}/" 
)

# Specify the directory containing the shared libraries.
set(PE_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/PE-engine/Debug")
set(BYTE_PIXEL_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/byte-pixel-engine/Debug")
set(SAM_PARSER_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/sam-parser/Debug")
set(SAM_ENGINE_LIB_DIR "${PROJECT_BINARY_DIR}/sam-engine/Debug")

# Specify the shared libraries.
set(PE_ENGINE_LIB_DLL "${PE_ENGINE}.dll")
set(BYTE_PIXEL_ENGINE_LIB_DLL "${BYTE_PIXEL_ENGINE}.dll")
set(SAM_PARSER_LIB_DLL "${SAM_PARSER}.dll")
set(SAM_ENGINE_LIB_DLL "${SAM_ENGINE}.dll")

# Copy the shared libraries to the executable directory.
add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy
            "${PE_ENGINE_LIB_DIR}/${PE_ENGINE_LIB_DLL}"
            "${BYTE_PIXEL_ENGINE_LIB_DIR}/${BYTE_PIXEL_ENGINE_LIB_DLL}"
            "${SAM_PARSER_LIB_DIR}/${SAM_PARSER_LIB_DLL}"
            "${SAM_ENGINE_LIB_DIR}/${SAM_ENGINE_LIB_DLL}"
            "$<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>"
    COMMENT "Copying ${PE_ENGINE_LIB_DLL}, ${BYTE_PIXEL_ENGINE_LIB_DLL}, ${SAM_PARSER_LIB_DLL}, and ${SAM_ENGINE_LIB_DLL} to the executable directory."
)

# TODO: Why is this needed?
add_test(NAME ${SAM_ENGINE_TESTS} COMMAND ${SAM_ENGINE_TESTS})
