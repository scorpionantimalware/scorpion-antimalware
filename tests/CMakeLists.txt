set(SAM_ENGINE_TESTS "sam-engine-tests")

file(GLOB SAM_ENGINE_TESTS_SRC_FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/testsmain.h
    ${CMAKE_CURRENT_SOURCE_DIR}/testsmain.cpp
    # ${CMAKE_CURRENT_SOURCE_DIR}/dummypegenerator.h
    # ${CMAKE_CURRENT_SOURCE_DIR}/dummypegenerator.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/samenginetests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/byte-pixel-engine/bytepixelenginetests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/PE-pathls-generator/pepathlscollectortests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/PE-pathls-generator/pepathlsgeneratortests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/PE-engine/peenginetests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/models/staticannpeclassifiertests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/models/staticcnnpeclassifiertests.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/sam-engine/scan-areas-processor/scanareasprocessortests.cpp
)

# Safety check: Ensure that all the files exist.
foreach(file ${SAM_ENGINE_TESTS_SRC_FILES})
    if(NOT EXISTS "${file}")
        message(FATAL_ERROR "File '${file}' does not exist!")
    endif()
endforeach()

# TODO: Is this needed?
enable_testing()

# For Windows: Prevent overriding the parent project's compiler/linker settings as mentioned in the official documentation.
if(WIN32)
    set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
endif()

set(GTEST_LIBRARIES 
    "GTest::gtest" 
    "GTest::gtest_main" 
)

# Check https://cmake.org/cmake/help/latest/module/FindGTest.html for more information.
find_package(GTest CONFIG)
if(NOT GTest_FOUND)
    set(SAM_GTEST_MAIN_HEADER "${SAM_ROOTDIR}/externals/googletest/googletest/include/gtest/gtest.h")

    if (NOT EXISTS "${SAM_GTEST_MAIN_HEADER}")
        message(FATAL_ERROR "Cannot find GTest package.")
    endif()

    message(STATUS "Found GTest: ${SAM_GTEST_MAIN_HEADER}")

    option(BUILD_SHARED_LIBS "Build shared libraries (DLLs)." ON)
    option(BUILD_GMOCK "Builds the googlemock subproject" OFF)
    option(INSTALL_GTEST "Enable installation of googletest. (Projects embedding googletest may want to turn this OFF.)" OFF)
    option(
        gtest_force_shared_crt
        "Use shared (DLL) run-time lib even when Google Test is built as static lib."
        ON)
    
    set(SAM_GTEST_ROOTDIR "${SAM_ROOTDIR}/externals/googletest")
    set(SAM_GTEST_BUILD_ROOTDIR "${SAM_ROOTDIR}/.build/.googletest-build")
    add_subdirectory(${SAM_GTEST_ROOTDIR} ${SAM_GTEST_BUILD_ROOTDIR})
endif()

# The LIEF version that we are using.
# set(LIEF_VERSION "0.14.1")

# Find LIEF. If LIEF was not installed into a default system directory then
# specify the following option during CMake configuration:
# -DLIEF_DIR=<LIEF install prefix>/share/LIEF/cmake
# find_package(LIEF COMPONENTS SHARED)
# if(NOT LIEF_FOUND)
#     set(SAM_LIEF_MAIN_HEADER "${SAM_ROOTDIR}/externals/lief/include/LIEF/LIEF.hpp")
#
#     if (NOT EXISTS "${SAM_LIEF_MAIN_HEADER}")
#         message(FATAL_ERROR "Cannot find LIEF package.")
#     endif()
#
#     message(STATUS "Found LIEF: ${SAM_LIEF_MAIN_HEADER}")
#
#     option(LIEF_DOC "Build LIEF docs" OFF)
#     option(LIEF_PYTHON_API "Build LIEF Python API" OFF)
#     option(LIEF_EXAMPLES "Build LIEF examples" OFF)
#     option(LIEF_TESTS "Build LIEF tests" OFF)
#     option(LIEF_INSTALL "Generate the install target." OFF)
#
#     if(MSVC)
#         set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded" CACHE STRING "CRT option")
#     endif()
#
#     set(SAM_LIEF_ROOTDIR "${SAM_ROOTDIR}/externals/lief")
#     set(SAM_LIEF_BUILD_ROOTDIR "${SAM_ROOTDIR}/.build/.lief-build")
#
#     add_subdirectory(${SAM_LIEF_ROOTDIR} ${SAM_LIEF_BUILD_ROOTDIR})
# endif()

add_executable(${SAM_ENGINE_TESTS} ${SAM_ENGINE_TESTS_SRC_FILES})

set_target_properties(${SAM_ENGINE_TESTS} PROPERTIES 
    VERSION ${SAM_PROJECT_VERSION}
    # LINK_FLAGS "/ignore:4197" # Ignore the warning LNK4197
)

target_link_libraries(${SAM_ENGINE_TESTS} PRIVATE 
    ${GTEST_LIBRARIES} 
    # LIEF::LIEF
    ${SAM_ENGINE} 
)

# When we use any header inside ${SAM_ENGINE_TESTS}, it must know where these headers are.
target_include_directories(${SAM_ENGINE_TESTS} PRIVATE 
    "${CMAKE_CURRENT_SOURCE_DIR}" 
    "${SAM_ROOTDIR}/externals/googletest/googletest/include" 
    # "${SAM_ROOTDIR}/externals/lief/include" 
)

# Specify the directory containing the shared libraries.
set(SAM_PE_ENGINE_BUILD_ROOTDIR "${PROJECT_BINARY_DIR}/sam-engine/PE-engine")
set(SAM_BYTE_PIXEL_ENGINE_BUILD_ROOTDIR "${PROJECT_BINARY_DIR}/sam-engine/byte-pixel-engine")
set(SAM_PE_PATHLS_GENERATOR_BUILD_ROOTDIR "${PROJECT_BINARY_DIR}/sam-engine/PE-pathls-generator")
set(SAM_SAM_MODELS_BUILD_ROOTDIR "${PROJECT_BINARY_DIR}/sam-engine/models")
set(SAM_SCAN_AREAS_PROCESSOR_BUILD_ROOTDIR "${PROJECT_BINARY_DIR}/sam-engine/scan-areas-processor")
set(SAM_SAM_ENGINE_BUILD_ROOTDIR "${PROJECT_BINARY_DIR}/sam-engine")

# TODO: Why copy_if_different isn't working?
# Copy the shared libraries to the executable directory.
file(GLOB SAM_DLLS 
    "${SAM_PE_ENGINE_BUILD_ROOTDIR}/Debug/${PE_ENGINE}.dll"
    "${SAM_BYTE_PIXEL_ENGINE_BUILD_ROOTDIR}/Debug/${BYTE_PIXEL_ENGINE}.dll"
    "${SAM_PE_PATHLS_GENERATOR_BUILD_ROOTDIR}/Debug/${PE_PATHLS_GENERATOR}.dll"
    "${SAM_SAM_MODELS_BUILD_ROOTDIR}/Debug/${SAM_MODELS}.dll"
    "${SAM_SAM_ENGINE_BUILD_ROOTDIR}/Debug/${SAM_ENGINE}.dll"
    "${SAM_SCAN_AREAS_PROCESSOR_BUILD_ROOTDIR}/Debug/${SCAN_AREAS_PROCESSOR}.dll"
)

# Safety check: Ensure that all the files exist.
foreach(file ${SAM_DLLS})
    if(NOT EXISTS "${file}")
        message(FATAL_ERROR "File '${file}' does not exist!")
    endif()
endforeach()

foreach(SAM_DLL ${SAM_DLLS})
    add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy ${SAM_DLL} $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                    COMMENT "Copying ${SAM_DLL} to the executable directory."
    )
endforeach()

# Copy the GTest dlls to the executable directory.
file(GLOB GTEST_DLLS 
    "${PROJECT_BINARY_DIR}/bin/Debug/gtest.dll" 
    "${PROJECT_BINARY_DIR}/bin/Debug/gtest_main.dll" 
)

# Safety check: Ensure that all the files exist.
foreach(file ${GTEST_DLLS})
    if(NOT EXISTS "${file}")
        message(FATAL_ERROR "File '${file}' does not exist!")
    endif()
endforeach()

foreach(GTEST_DLL ${GTEST_DLLS})
    add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy ${GTEST_DLL}  $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                    COMMENT "Copying ${GTEST_DLL} to the executable directory."
    )
endforeach()

# Copy the onnx dlls to the executable directory.
if (MSVC)
    file(GLOB ORT_DLLS 
        "${SAM_ONNXRUNTIME_ROOTDIR}/lib/onnxruntime.dll"
        "${SAM_ONNXRUNTIME_ROOTDIR}/lib/onnxruntime_providers_shared.dll"
    )

    # Safety check: Ensure that all the files exist.
    foreach(file ${ORT_DLLS})
        if(NOT EXISTS "${file}")
            message(FATAL_ERROR "File '${file}' does not exist!")
        endif()
    endforeach()

    foreach(ORT_DLL ${ORT_DLLS})
        add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                        COMMAND ${CMAKE_COMMAND} -E copy ${ORT_DLL}  $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                        COMMENT "Copying ${ORT_DLL} to the executable directory."
        )
    endforeach()
endif()

# Copy the lief dlls to the executable directory.
# file(GLOB LIEF_DLLS 
#     "${PROJECT_BINARY_DIR}/.lief-build/Debug/LIEF.dll" 
# )
#
# Safety check: Ensure that all the files exist.
# foreach(file ${LIEF_DLLS})
#     if(NOT EXISTS "${file}")
#         message(FATAL_ERROR "File '${file}' does not exist!")
#     endif()
# endforeach()
#
# foreach(LIEF_DLL ${LIEF_DLLS})
#     add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
#                     COMMAND ${CMAKE_COMMAND} -E copy ${LIEF_DLL}  $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
#                     COMMENT "Copying ${LIEF_DLL} to the executable directory."
#     )
# endforeach()

# Copy the model to the executable directory.
file(GLOB SAM_MODELS 
    "${SAM_STATIC_ANN_ONNX_MODELPATH}"
    "${SAM_STATIC_ANN_STANDARDIZE_PARAMS}"
    "${SAM_STATIC_CNN_ONNX_MODELPATH}"
    "${SAM_STATIC_CNN_COLORMAP}"
)

# Safety check: Ensure that all the files exist.
foreach(file ${SAM_MODELS})
    if(NOT EXISTS "${file}")
        message(FATAL_ERROR "File '${file}' does not exist!")
    endif()
endforeach()

foreach(SAM_MODEL ${SAM_MODELS})
    add_custom_command(TARGET ${SAM_ENGINE_TESTS} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy ${SAM_MODEL} $<TARGET_FILE_DIR:${SAM_ENGINE_TESTS}>
                    COMMENT "Copying ${SAM_MODEL} to the executable directory."
    )
endforeach()

# TODO: Why is this needed?
add_test(NAME ${SAM_ENGINE_TESTS} COMMAND ${SAM_ENGINE_TESTS})
