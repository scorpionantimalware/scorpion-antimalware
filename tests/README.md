# Scorpion Anti-malware Tests

# Building Tests

1. Get Gtest.
```bash
git clone https://github.com/google/googletest.git
```

2. Change directory to the root of googletest.
```bash
cd googletest/
```

3. Make a new directory for CMake build output.
```bash
mkdir build/
```

4. Change directory.
```bash
cd .build/
```

5. Run CMake.
```bash
cmake .. -G "Visual Studio 17 2022" -DBUILD_SHARED_LIBS=ON
```

6. Build GTest libraries.
```bash
cmake --build .
```

7. Install the libraries. Default location is ``C:/Program Files (x86)/googletest-distribution``. Note that you don't have write permission inside ``Program Files (x86)`` directory so this command will fail so you must run the command line as administrator.
```bash
cmake --install . --config Debug
```

8. Add ``C:/Program Files (x86)/googletest-distribution/bin`` to your PATH.

9. Download [onnxruntime-win-x64-1.17.1.zip](https://github.com/microsoft/onnxruntime/releases/download/v1.17.1/onnxruntime-win-x64-1.17.1.zip) and extract the zip file anywhere. You can find latest version in [microsoft/onnxruntime/releases/](https://github.com/microsoft/onnxruntime/releases/).

10. [Optional] You can also download [onnxruntime-win-x64-cuda12-1.17.1.zip](https://github.com/microsoft/onnxruntime/releases/download/v1.17.1/onnxruntime-win-x64-cuda12-1.17.1.zip) or [onnxruntime-win-x64-gpu-1.17.1.zip](https://github.com/microsoft/onnxruntime/releases/download/v1.17.1/onnxruntime-win-x64-gpu-1.17.1.zip).

11. Download our static ANN and CNN onnx models.

12. Change directory to SAM's root.
```bash
cd scorpion-antimalware/
```

13. Make a new directory for CMake build output.
```bash
mkdir build/
```

14. Change directory.
```bash
cd .build/
```

15. Now build SAM with ``BUILD_TESTS`` macro equals to ``ON`` and provide the path of GTest to ``CMAKE_PREFIX_PATH``.
```bash
cmake .. -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE=Debug -DLINK_CONSOLE=OFF -DBUILD_TESTS=ON -DCMAKE_PREFIX_PATH="C:/Program Files (x86)/googletest-distribution/lib/cmake/GTest" -DONNXRUNTIME_ROOTDIR="path/to/onnxruntime-win-x64-1.17.1" -DSTATIC_ANN_ONNX_MODELPATH="path/to/ANN-78M-in2381-h11-out1-v0.onnx"
```

16. Build.
```bash
cmake --build .
```

17. Run tests. This command runs all of our tests. You can specify a subset as well.
```bash
./tests/Debug/sam-engine-tests.exe
```
