###################################################################################
#                                                                                 #
# sam-engine/PE-engine/CMakeLists.txt                                             #
#                                                                                 #
###################################################################################
#                                                                                 #
#    Scorpion Anti-malware is a free Open Source AI-powered Anti-malware          #
#    framework for Researchers.                                                   #
#                                                                                 #
#    Copyright (c) 2024-present  (see AUTHORS.md).                                #
#                                                                                 #
#    This program is free software: you can redistribute it and/or modify         #
#    it under the terms of the GNU General Public License as published by         #
#    the Free Software Foundation, either version 3 of the License, or            #
#    (at your option) any later version.                                          #
#                                                                                 #
#    This program is distributed in the hope that it will be useful,              #
#    but WITHOUT ANY WARRANTY; without even the implied warranty of               #
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                #
#    GNU General Public License for more details.                                 #
#                                                                                 #
#    You should have received a copy of the GNU General Public License            #
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.       #
#                                                                                 #
###################################################################################


# Caching the library name to be used in the parent scope.
set(SAM_PE_ENGINE "sam_pe_engine" CACHE STRING "PE Engine library name.")

file(GLOB SAM_PE_ENGINE_HPP_FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/peengine.hpp    
)

file(GLOB SAM_PE_ENGINE_CPP_FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/peengine.cpp
)

# Safety check: Ensure that all the files exist.
foreach(file ${SAM_PE_ENGINE_CPP_FILES} ${SAM_PE_ENGINE_HPP_FILES})
    if(NOT EXISTS "${file}")
        message(FATAL_ERROR "File '${file}' does not exist!")
    endif()
endforeach()

add_library(${SAM_PE_ENGINE} SHARED 
    ${SAM_PE_ENGINE_CPP_FILES} 
)

set_target_properties(${SAM_PE_ENGINE} PROPERTIES VERSION ${SAM_PROJECT_VERSION})

# The Python_LIBRARIES variable comes from the find_package(Python) call in the parent scope.
# Replace PYTHON_LIBRARIES with Python_LIBRARIES in the future.
target_link_libraries(${SAM_PE_ENGINE} PUBLIC 
    pybind11::embed
)

# The Python_INCLUDE_DIRS variable comes from the find_package(Python) call in the parent scope.
# Replace PYTHON_INCLUDE_DIRS with Python_INCLUDE_DIRS in the future.
target_include_directories(${SAM_PE_ENGINE} PUBLIC 
    "${CMAKE_CURRENT_SOURCE_DIR}/" 
    "${pybind11_INCLUDE_DIRS}/" 
)

################ Check Standardize Params ################

if(NOT SAM_STATIC_ANN_STANDARDIZE_PARAMS)
    set(DESIRED_STANDARDIZE_PARAMS_PATH "${SAM_ROOTDIR}/.models/static/ann/standardize-params.pkl")
    set(DESIRED_STANDARDIZE_PARAMS_GDRIVE_ID "1-KdjYr-yPy9AyLHVsqQEJAHJQ2-l6GtR")
    download_model_if_not_exist(${DESIRED_STANDARDIZE_PARAMS_GDRIVE_ID} ${DESIRED_STANDARDIZE_PARAMS_PATH})
    set(SAM_STATIC_ANN_STANDARDIZE_PARAMS ${DESIRED_STANDARDIZE_PARAMS_PATH})
endif()

if (NOT EXISTS ${SAM_STATIC_ANN_STANDARDIZE_PARAMS})
    message(FATAL_ERROR "${SAM_STATIC_ANN_STANDARDIZE_PARAMS} not found.")
else()
    message(STATUS "SAM_STATIC_ANN_STANDARDIZE_PARAMS: ${SAM_STATIC_ANN_STANDARDIZE_PARAMS}")
endif()

# Extract the file extension
get_filename_component(SAM_STATIC_ANN_STANDARDIZE_PARAMS_FILE_EXTENSION "${SAM_STATIC_ANN_STANDARDIZE_PARAMS}" EXT)

# Check if the extension is .onnx (note that the extracted extension includes the dot)
if (NOT SAM_STATIC_ANN_STANDARDIZE_PARAMS_FILE_EXTENSION STREQUAL ".pkl")
    message(FATAL_ERROR "The ANN standardize parameters must have .pkl file extension.")
endif()

################################################################

# A Path to the scripts directory.
set(SAM_PE_ENGINE_SCRIPTS_DIR "${CMAKE_CURRENT_SOURCE_DIR}/scripts")

target_compile_definitions(${SAM_PE_ENGINE} PUBLIC 
    SAM_PE_ENGINE_SCRIPTS_DIR="${SAM_PE_ENGINE_SCRIPTS_DIR}"
    SAM_STATIC_ANN_STANDARDIZE_PARAMS="${SAM_STATIC_ANN_STANDARDIZE_PARAMS}"
)

# Install the library.
# This is for CPack to be able to package the library.
install(TARGETS ${SAM_PE_ENGINE} RUNTIME DESTINATION .)
