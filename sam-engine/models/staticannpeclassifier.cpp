#include "staticannpeclassifier.h"

#include <filesystem>

namespace fs = std::filesystem;

#include <iostream>

StaticANNPEClassifier::StaticANNPEClassifier() : run_options(nullptr), env(nullptr), session(nullptr) {
    std::string model_path = STATIC_ANN_ONNX_MODELPATH;
    
    std::wstring widestr = std::wstring(model_path.begin(), model_path.end());
    const wchar_t* widecstr = widestr.c_str();

    StaticANNPEClassifier::run_options = new Ort::RunOptions();
    
    

    StaticANNPEClassifier::env = new Ort::Env();

    // Use CPU
    StaticANNPEClassifier::session = new Ort::Session(*env, widecstr, Ort::SessionOptions{ nullptr });
}

StaticANNPEClassifier::~StaticANNPEClassifier() {
    if (session != nullptr) {
        delete session;
    }

    if (env != nullptr) {
        delete env;
    }

    if (run_options != nullptr) {
        delete run_options;
    }
}

bool StaticANNPEClassifier::classify(const std::string& pe_file_path, const std::vector<float>& input_features, float& output) {
    // define shape
    const std::array<int64_t, 2> input_shape = { 1, NUM_INPUT_ELEMENTS };
    const std::array<int64_t, 2> output_shape = { 1, NUM_CLASSES };

    // define array
    std::array<float, NUM_INPUT_ELEMENTS> input;
    std::array<float, NUM_CLASSES> results;

    // define Tensor
    auto memory_info = Ort::MemoryInfo::CreateCpu(OrtDeviceAllocator, OrtMemTypeCPU);
    auto input_tensor = Ort::Value::CreateTensor<float>(memory_info, input.data(), input.size(), input_shape.data(), input_shape.size());
    auto output_tensor = Ort::Value::CreateTensor<float>(memory_info, results.data(), results.size(), output_shape.data(), output_shape.size());

    // define names
    Ort::AllocatorWithDefaultOptions ort_alloc;
    Ort::AllocatedStringPtr input_name = session->GetInputNameAllocated(0, ort_alloc);
    Ort::AllocatedStringPtr output_name = session->GetOutputNameAllocated(0, ort_alloc);
    const std::array<const char*, 1> input_names = { input_name.get()};
    const std::array<const char*, 1> output_names = { output_name.get()};
    input_name.release();
    output_name.release();

    session->Run(
        *StaticANNPEClassifier::run_options, 
        input_names.data(), 
        &input_tensor, 
        1, 
        output_names.data(), 
        &output_tensor, 
        1
    );

    output = results[0];

    return true;
}
