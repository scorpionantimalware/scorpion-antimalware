@echo off

REM Function to download a file from Google Drive
:download_gdrive
rem %1 = Google Drive file ID
rem %2 = Destination filename

if "%~1"=="" (
    echo [ERROR] File ID is required.
    exit /b 1
)

if "%~2"=="" (
    echo [ERROR] Destination filename is required.
    exit /b 1
)

echo Downloading %2 from Google Drive...

powershell -Command "Invoke-WebRequest -Uri 'https://drive.google.com/uc?export=download&id=%~1' -OutFile '%~2'"

if %errorlevel% neq 0 (
    echo [ERROR] Failed to download %2.
    exit /b 1
)

echo [INFO] Successfully downloaded %2.
exit /b 0

REM End of function
goto :eof

call :download_gdrive "17FbftyZuSLI7Nin3IJAq9U7QV23AUN_3" "ann.onnx"
call :download_gdrive "1-KdjYr-yPy9AyLHVsqQEJAHJQ2-l6GtR" "ann_standardize_params.pkl"
call :download_gdrive "1-I7BqXz0NiuVyi-B8pr_T3wlfSqrk_gp" "cnn.onnx"
call :download_gdrive "1BzRWwjpM0lcRkuk2uLKlgQm3GzEKWZcJ" "cnn_gray_colormap.npy"
call :download_gdrive "1B9LjPI4cb9iYRuVCvZBpb32DMjaDGuvP" "bigru.onnx"

REM Download ONNX Runtime
echo Downloading ONNX Runtime...
powershell -Command "Invoke-WebRequest -Uri 'https://github.com/microsoft/onnxruntime/releases/download/v1.17.1/onnxruntime-win-x64-1.17.1.zip' -OutFile 'onnxruntime.zip'"

REM Unzip ONNX Runtime
echo Unzipping ONNX Runtime...
powershell -Command "Expand-Archive -Path 'onnxruntime.zip' -DestinationPath 'onnxruntime'"

REM Get Root Directory
for /d %%D in (onnxruntime\*) do set rootDir=%%D
echo Root directory of the unzipped file is: %rootDir%

REM Run CMake
echo Running CMake...
cmake -S . -B .build/ -G "Visual Studio 17 2022" ^
  -DSAM_STATIC_ANN_ONNX_MODELPATH="ann.onnx" ^
  -DSAM_STATIC_ANN_STANDARDIZE_PARAMS="ann_standardize_params.pkl" ^
  -DSAM_STATIC_CNN_ONNX_MODELPATH="cnn.onnx" ^
  -DSAM_STATIC_CNN_COLORMAP="cnn_gray_colormap.npy" ^
  -DSAM_DYNAMIC_CNN_BIGRU_ONNX_MODELPATH="bigru.onnx" ^
  -DSAM_ONNXRUNTIME_ROOTDIR="%rootDir%" ^
  -DSAM_BUILD_TESTS=ON ^
  -DSAM_BUILD_CLI_TOOLS=ON ^
  -DSAM_LINK_CONSOLE=OFF

REM Build the Engine
echo Building the Engine...
cmake --build .build/ --config Debug

REM Run engine tests
echo Invoking engine tests...
.\.build\tests\Debug\sam-engine-tests.exe

echo Done.
pause
