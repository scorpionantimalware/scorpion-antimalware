from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
import time


def get_4_pages_hashs(driver):
    driver.get("https://bazaar.abuse.ch/browse/")
    # Wait for the table to be loaded
    wait = WebDriverWait(driver, 60)
    wait.until(EC.presence_of_element_located((By.ID, "samples")))
    list_of_exe_hashs = []
    ### change pages
    pages_xpaths = [f'//*[@id="samples_paginate"]/ul/li[{i}]' for i in reversed(range(2, 6))]
    for xpath in pages_xpaths:
        driver.find_element(By.XPATH, xpath).click()
        time.sleep(2)
        table = driver.find_element(By.ID, "samples")
        # Locate the rows
        rows = table.find_elements(By.TAG_NAME, "tr")
        # Iterate through rows and find 'exe' type
        for row in rows:
            # Find all the cells in the row
            cells = row.find_elements(By.TAG_NAME, "td")
            if cells:
                # Check if the 'Type' column contains 'exe'
                type_cell = cells[2]
                if "exe" in type_cell.text.lower():
                    list_of_exe_hashs.append(cells[1].text)

    return list_of_exe_hashs


def downlaod_samples(list_of, driver):
    template = "https://bazaar.abuse.ch/download/xx/"
    for sample in list_of:
        sample_http = template.replace("xx", sample)
        driver.get(sample_http)
        driver.find_element(By.CLASS_NAME, "btn-primary").click()
        time.sleep(3)
    time.sleep(300)


chrome_options = Options()
chrome_options.add_argument("--window-size=1920,1080")
chrome_options.add_experimental_option("prefs", {"safebrowsing.enabled": True})
driver = webdriver.Chrome(options=chrome_options)

list_of_hashs = get_4_pages_hashs(driver)
downlaod_samples(list_of_hashs, driver)
